name: Deploy to GitHub Pages

on:
  # å½“æ¨é€åˆ°masteråˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [ "master", "main" ]
    paths-ignore:
      - "**.md"
      - ".gitignore"
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ
  workflow_dispatch:
    inputs:
      force:
        description: 'å¼ºåˆ¶éƒ¨ç½²ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        type: boolean
        default: false

# è®¾ç½®GITHUB_TOKENçš„æƒé™ä»¥å…è®¸éƒ¨ç½²åˆ°GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write
  deployments: write

# å…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºå·¥ä½œ
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      - name: è®¾ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
        
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4
        with:
          enablement: true
          
      - name: éªŒè¯Pagesé…ç½®çŠ¶æ€
        run: |
          echo "GitHub Pages URL: ${{ steps.pages.outputs.base_url || 'æœªé…ç½®' }}"
          echo "æº: ${{ steps.pages.outputs.source || 'æœªé…ç½®' }}"
          echo "æ„å»ºç±»å‹: ${{ steps.pages.outputs.build_type || 'æœªé…ç½®' }}"
        
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci || npm install
          
      - name: Build
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»º..."
          npm run build
          echo "âœ… æ„å»ºå®Œæˆ!"
          
      - name: éªŒè¯æ„å»ºè¾“å‡º
        run: |
          echo "ğŸ“‚ éªŒè¯æ„å»ºè¾“å‡º..."
          if [ -d "dist" ]; then
            echo "âœ… distç›®å½•å­˜åœ¨"
            ls -la dist/
            if [ -f "dist/index.html" ]; then
              echo "âœ… index.htmlæ–‡ä»¶å­˜åœ¨"
            else
              echo "âŒ index.htmlæ–‡ä»¶ä¸å­˜åœ¨!"
              exit 1
            fi
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œdistç›®å½•ä¸å­˜åœ¨!"
            exit 1
          fi
          
      # ä½¿ç”¨JamesIves/github-pages-deploy-actionä½œä¸ºå¤‡é€‰éƒ¨ç½²æ–¹æ³•
      - name: éƒ¨ç½²åˆ°GitHub Pages (å¤‡é€‰æ–¹æ³•)
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
          clean: true
          force: ${{ github.event.inputs.force == 'true' }}
          
      - name: Upload artifact (GitHub Actionsæ–¹æ³•)
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  # éƒ¨ç½²å·¥ä½œ
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: éƒ¨ç½²å‰éªŒè¯
        run: |
          echo "ğŸš€ å‡†å¤‡éƒ¨ç½²åˆ°GitHub Pages..."
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "æ—¶é—´: $(date)"
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: éƒ¨ç½²å®Œæˆ
        if: steps.deployment.outcome == 'success'
        run: |
          echo "âœ… GitHub Pageséƒ¨ç½²æˆåŠŸ!"
          echo "ğŸŒ ç½‘ç«™åœ°å€: ${{ steps.deployment.outputs.page_url }}"
          echo "â±ï¸ éƒ¨ç½²æ—¶é—´: $(date)"
